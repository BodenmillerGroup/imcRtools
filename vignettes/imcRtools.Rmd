---
title: "R Tools for IMC Data"
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('imcRtools')`"
author:
- name: Tobias Hoch
  affiliation: Department for Quantitative Biomedicine, University of Zurich
  email: tobias.hoch@bluewin.ch
- name: Nils Eling
  affiliation: Department for Quantitative Biomedicine, University of Zurich
  email: nils.eling@dqbm.uzh.ch
output:
    BiocStyle::html_document:
        toc_float: yes
bibliography: library.bib
abstract: |
    Abstract
vignette: |
    %\VignetteIndexEntry{"R Tools for IMC Data}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, results="hide"}
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE,
                        fig.retina = 0.75, crop = NULL)
library(BiocStyle)
```

```{r library, echo=FALSE}
library(imcRtools)
```

# Introduction

This vignette gives an introduction to .....

IMC [@giesen2014imc] is a multiplexed imaging cytometry approach to measure spatial
protein abundance. In IMC, tissue sections are stained with a mix of
around 40 metal-conjugated antibodies prior to laser ablation with $1\mu{}m$
resolution. The ablated material is transferred to a mass cytometer for
time-of-flight detection of the metal ions [@giesen2014imc][@mavropoulosimc]. In
that way, hundreds of images (usually with an image size of around 1mm x 1mm)
can be generated in a reasonable amount of time [@damond2019pancreas].

Raw IMC data are computationally processed using a segmentation pipeline
(available at
[https://github.com/BodenmillerGroup/ImcSegmentationPipeline](https://github.com/BodenmillerGroup/ImcSegmentationPipeline)).
This pipeline produces image stacks containing the raw pixel values for up to 40
channels, segmentation masks containing the segmented cells, cell-level
expression and metadata information as well as a number of image-level meta
information.

Cell-level expression and metadata can be processed and read into a
`SingleCellExperiment` class object. 

The `cytomapper` package provides a new `CytoImageList` class as a container for
multiplexed images or segmentation masks. For more information on this class,
refer to the [CytoImageList](#CytoImageList) section.

The main functions of this package include `plotCells` and `plotPixels`. The
`plotCells` function requires the following object inputs to display cell-level
information (expression and metadata):

1. a `SingleCellExperiment` object, which contains the cells' counts and metadata
2. a `CytoImageList` object containing the segmentation masks

The `plotPixels` function requires the following object inputs to display
pixel-level expression information:

1. a `CytoImageList` object containing the pixel-level information per channel
2. (optionally) a `SingleCellExperiment` object, which contains the cells'
counts and metadata 
3. (optionally) a `CytoImageList` object containing the segmentation masks

# Quick start {#QuickStart}

The following section provides a quick example highlighting the functionality of
`cytomapper`. For detailed information on reading in the data, refer to the
[Reading in data](#ReadingData) section. More information on the required data
format is provided in the [Data formats](#DataFormats) section. In the first
step, we will read in the provided [toy dataset](#ToyData)

```{r quickstart-load-data}
#library(data.table)
# load the single cell data
#cells <- as.data.frame(fread(file = "data/hubmap_processed_v2/cell.csv",stringsAsFactors = FALSE))

# load the image level metadata
#image_mat <- as.data.frame(read.csv(file = "data/hubmap_processed_v2/Image.csv",stringsAsFactors = FALSE))

# load the panel information
#panel_mat <- read.csv(file = "data/hubmap_processed_v2/panel.csv", sep= ",",  stringsAsFactors = FALSE )

# get an example file that contains the channel order
#tags <- read.csv( "data/protein/20191021_ZTMA256.1_slide3_TH_s0_p9_r1_a1_ac_full.csv", header = FALSE)

# load acqusition meta data
#acquisition_meta <- read.csv(file = "data/hubmap_processed_v2/Experiment.csv", stringsAsFactors = FALSE)

# load the clinical data. this is a clinical datatable that already contains the ImageNumbers. It has been prepared in the clinical metadata preparation.Rmd script (prepared for RNA and protein dataset separately)
#clinical_mat <- read.csv("data/protein/clinical_data_protein.csv",stringsAsFactors = FALSE)
```

# Create a SingleCellExperiment Data Container

The `generateSCE` function allows to parse all relevant data and store in a handy `SingleCellExperiment` container. Find more information on the required input data in the help section. 

```{r quickstart-plotPixels}
#sce <- generateSCE(cells = cells,
#                   cell_meta = c("ImageNumber", "ObjectNumber"),
#                   image_meta = image_mat,
#                   panel_meta = panel_mat,
#                   metal_tag = "Metal.Tag",
#                   channel_number = "channel", 
#                   target_names = "clean_target",
#                   imageNumber = "ImageNumber",
#                   objectNumber = "ObjectNumber",
#                   measurement_column = "Intensity_MeanIntensityComp_FullStackFiltered",
#                   scaling_column = "Scaling_FullStack")
```

Once the data is loaded and stored, further `imcRtools` allow to visualize aspects of the data. 

# Acknowledgements


# Contributions


# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
