---
title: "R tools for IMC data analysis"
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('imcRtools')`"
author:
- name: Nils Eling
  affiliation: 
  - Department for Quantitative Biomedicine, University of Zurich
  - Institute for Molecular Health Sciences, ETH Zurich
  email: nils.eling@dqbm.uzh.ch
- name: Tobias Hoch
  affiliation: 
  - Department for Quantitative Biomedicine, University of Zurich
  - Institute for Molecular Health Sciences, ETH Zurich
output:
    BiocStyle::html_document:
        toc_float: yes
bibliography: library.bib
abstract: |
    Abstract
vignette: |
    %\VignetteIndexEntry{"R tools for IMC data analysis"}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, results="hide"}
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE,
                        fig.retina = 0.75, crop = NULL)
library(BiocStyle)
```

```{r library, echo=FALSE}
library(imcRtools)
```

# Introduction

This vignette gives an introduction to the `imcRtools` package.

## Imaging mass cytometry

# Example data

The `imcRtools` package contains a number of example data generated by the
Hyperion imaging system for different purposes. The following section gives an
overview of these files.

## For spillover correction

To highlight the use of the `imcRtools` package for spillover correction, 
we provide four .txt files containing pixel intensities of four spotted metals.

These files are accessible via:

```{r access-spillover-files}
path <- system.file("extdata/spillover", package = "imcRtools")
path
```

## Raw data in form of .txt files

To highlight reading in raw data in form of .txt files, the `imcRtools` contains
3 sample acquisitions:

```{r access-txt-files}
txt_files <- list.files(system.file("extdata/mockData/raw", 
                                    package = "imcRtools"))
txt_files
```

## `steinbock` output data

The [steinbock](https://github.com/BodenmillerGroup/steinbock) pipeline can be used
to process, segment and extract features from IMC data. For more information,
please refer to the [documentation](https://bodenmillergroup.github.io/steinbock/).

To highlight the functionality of `imcRtools` to read in single-cell data generated
by `steinbock`, we provide a small toy dataset available at:

```{r steinbock-to-data}
path <- system.file("extdata/mockData/steinbock", package = "imcRtools")

list.files(path, recursive = TRUE)
```

# Read in IMC data

## Read in CellProfiler output

The [ImcSegmentationPipeline](https://github.com/BodenmillerGroup/ImcSegmentationPipeline)
produces a number of output file. By default, all single-cell features are measured 
and exported. To select the features of interest, the `imcRtools` package provides
the `show_cpout_features` function. Here, the exported features can be interactively browsed:

```{r show_cpout_features}
path <- system.file("extdata/mockData/cpout", package = "imcRtools")

show_cpout_features(path)
```

## Read in steinbock output

Single-cell data and all associated metadata (e.g. spatial location, morphology
and interaction graphs) as produced by the
[steinbock](https://github.com/BodenmillerGroup/steinbock) pipeline can be read
in using the `read_steinbock` function.

By default, the single-cell data is read into a `r BiocStyle::Biocpkg("SpatialExperiment")` 
object. Here, the extracted channel- and cell-specific intensities are stored in
the `counts(spe)` slot. All morphological features are stored in `colData(spe)`
and the spatial locations of the cells are stored in `spatialCoords(spe)`.
The interaction graph is stored in `colPair(spe, "neighbourhood")`.

Alternatively, the data can be read into a `r BiocStyle::Biocpkg("SingleCellExperiment")`
object. The only difference is the lack of `spatialCoords(sce)`. Here, the 
spatial coordinates are stored in `colData(spe)$Pos_X` and `colData(spe)$Pos_Y`.

```{r read_steinbock}
cur_path <- system.file("extdata/mockData/steinbock", package = "imcRtools")

# Read as SpatialExperiment
(spe <- read_steinbock(cur_path))

# Read as SingleCellExperiment
(sce <- read_steinbock(cur_path, return_as = "sce"))
```

For more information on the `read_steinbock` function, please refer to
`?read_steinbock`.

## Read raw .txt files into `Image` objects

For reading in and visualization of multi-channel images and segmentation masks,
please refer to the `r BiocStyle::Biocpkg("cytomapper")` package. The
`imcRtools` package however supports reading in raw .txt files generated by the
Hyperion imaging system into a `CytoImageList` object; a data container exported
by `cytomapper`.

The user needs to provide a path from which all .txt files will be read in:

```{r read-txt-1}
path <- system.file("extdata/mockData/raw", package = "imcRtools")

cur_CytoImageList <- readImagefromTXT(path)
cur_CytoImageList
```

# Spillover correction for IMC data

When acquiring IMC images, pixel intensities can be influenced by spillover 
from neighbouring channels. To correct for this, Chevrier _et al._ have 
developed a staining protocol to acquire individually spotted metal isotopes
[@Chevrier].
Based on these measurements, spillover into neighbouring channels can be
quantified and pixel intensities can be deconvolved into true and spillover
signal. 

The `imcRtools` package provides helper functions that facilitate the correction
of spillover for IMC data. For a full tutorial, please refer to the [IMC data analysis book](https://bodenmillergroup.github.io/IMCDataAnalysis/spillover-correction.html#ref-Chevrier2017).

## Read in the single-spot acquisition

In the first step, the pixel intensities of individually spotted metals need to 
be read into a `SingleCellExperiment` container for downstream use with the
`CATALYST` package. For this, the `readSCEfromTXT` function can be used:

```{r read-single-metals}
path <- system.file("extdata/spillover", package = "imcRtools")
sce <- readSCEfromTXT(path) 
sce
```

Here, the example metal spot files are read in. The spot information are stored
in the `colData(sce)` slot and channel information are stored in `rowData(sce)`.
Each column represents a single pixel.

## Quality control on single-spot acquisitions

In the next step, it is crucial to identify potential mislabeled spots or spots 
with low pixel intensities, the `imcRtools` package exports the `plotSpotHeatmap`
function, which visualizes the aggregated (default `median`) pixel intensities
per spot and per metal:

```{r plotSpotHeatmap, fig.width=5, fig.height=5}
plotSpotHeatmap(sce)
```

Here, high median pixel intensities can be observed in each spot an their 
corresponding channels (visualized on the `log10` scale).
To quickly identify spot/channel combinations with low signal, the `threshold`
parameter can be set:

```{r plotSpotHeatmap-2, fig.width=5, fig.height=5}
plotSpotHeatmap(sce, log = FALSE, threshold = 200)
```

## Consecutive pixel binning

If pixel intensities are low, spillover estimation might not be robust. 
Therefore, the `binAcrossPixels` function can be used to sum consecutive pixels
and enhance the acquired signal. This step is optional for spillover estimation.

```{r pixel-binning, fig.width=5, fig.height=5 }
sce2 <- binAcrossPixels(sce, bin_size = 5)

plotSpotHeatmap(sce2, log = FALSE, threshold = 200)
```

## Pixel filtering

Prior to spillover estimation, the `r BiocStyle::Biocpkg("CATALYST")` package
provides the `assignPrelim`, `estCutoffs` and `applyCutoffs` functions to
estimate the spotted mass for each pixel based on their channel intensities.
For more information on the spillover estimation and correction, please refer
to the [CATALYST vignette]().

This estimation can be used to identify pixels that cannot be easily assigned
to their spotted mass, potentially indicating pixels with weak signal. To remove
these pixels, the `filterPixels` function can be used. This function further
removes pixels assigned to masses, which only contain very few pixels.

```{r assign-pixels}
library(CATALYST)

bc_key <- as.numeric(unique(sce$sample_mass))
assay(sce, "exprs") <- asinh(counts(sce)/5)
sce <- assignPrelim(sce, bc_key = bc_key)
sce <- estCutoffs(sce)
sce <- applyCutoffs(sce)

# Filter out mislabelled pixels
sce <- filterPixels(sce)

table(sce$bc_id, sce$sample_mass)
```

## Estimating the spillover matrix

Finally, the pre-processed `SiingleCellExperiment` object can be used to 
generate the spillover matrix using the `CATALYST::computeSpillmat` function:

```{r estimate-spillover}
sce <- computeSpillmat(sce)
metadata(sce)$spillover_matrix
```

# Acknowledgements

# Contributions

# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
